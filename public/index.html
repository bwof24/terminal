<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
    <style>
        body, html {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            background-color: black;
            font-family: monospace;
            color: white;
        }
        #terminal-container {
            flex: 1;
            display: flex;
            background-color: black;
            padding: 10px;
        }
        #terminal {
            width: 100%;
            height: 100%;
        }
        #file-management {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #333;
        }
        #preferences {
            padding: 10px;
            background-color: #333;
        }
        button {
            padding: 10px;
            margin: 5px;
            background-color: #444;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <div id="file-management">
        <input type="file" id="fileUpload" />
        <button id="uploadBtn">Upload File</button>
        <button id="downloadBtn">Download File</button>
    </div>
    <div id="preferences">
        <label for="fontSize">Font Size:</label>
        <input type="number" id="fontSize" value="14" />
        <button id="savePreferences">Save Preferences</button>
    </div>
    <div id="terminal-tabs">
        <button id="newTab">New Tab</button>
    </div>
    <div id="terminal-container"></div>
    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script>
        const termInstances = {};
        let currentTab = null;

        function createNewTab() {
            const tabId = generateUniqueId();
            const term = new Terminal();
            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            const tabContainer = document.createElement('div');
            tabContainer.id = `terminal-${tabId}`;
            tabContainer.style.width = '100%';
            tabContainer.style.height = '100%';
            document.getElementById('terminal-container').appendChild(tabContainer);
            term.open(tabContainer);
            fitAddon.fit();

            const ws = new WebSocket(`ws://${window.location.host}`);

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.sessionId === tabId) {
                    term.write(message.data);
                }
            };

            term.onData((data) => {
                ws.send(JSON.stringify({ sessionId: tabId, data }));
            });

            termInstances[tabId] = { term, ws };
            currentTab = tabId;
        }

        document.getElementById('newTab').addEventListener('click', createNewTab);

        document.getElementById('uploadBtn').addEventListener('click', () => {
            const fileInput = document.getElementById('fileUpload');
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            }).then(response => response.text())
              .then(message => alert(message));
        });

        document.getElementById('downloadBtn').addEventListener('click', () => {
            const filename = prompt('Enter filename to download:');
            if (filename) {
                window.location.href = `/download/${filename}`;
            }
        });

        document.getElementById('savePreferences').addEventListener('click', () => {
            const fontSize = document.getElementById('fontSize').value;
            const preferences = { fontSize };

            fetch('/save-preferences', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: 'user-id', preferences })
            }).then(response => response.text())
              .then(message => alert(message));
        });

        function generateUniqueId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Initialize with one tab
        createNewTab();
    </script>
</body>
</html>
