<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />
    <style>
        body, html {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            background-color: black;
            overflow: hidden;
        }
        #terminal-container {
            flex: 1;
            display: flex;
            background-color: black;
            overflow: auto;
        }
        .xterm {
            background-color: black;
            color: white;
            width: 100%;
            height: 100%;
            user-select: text;
            -webkit-user-select: text;
        }
        #controls {
            display: flex;
            justify-content: center;
            padding: 10px;
            background-color: #333;
        }
        button {
            margin: 0 5px;
            padding: 5px 10px;
            color: white;
            background-color: #555;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #777;
        }
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #555;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button id="new-session-btn">New Session</button>
        <button id="clear-btn">Clear</button>
        <button id="save-btn">Save Output</button>
        <button id="exit-btn">Exit</button>
        <button id="copy-btn">Copy</button>
        <button id="download-btn">Download Output</button>
        <button id="command-btn">Run Command</button>
    </div>
    <div id="terminal-container"></div>
    <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links/lib/xterm-addon-web-links.js"></script>
    <script>
        let terminals = [];
        let currentTerminalIndex = 0;
        const logs = {};

        function createTerminal() {
            const terminalContainer = document.getElementById('terminal-container');
            const term = new Terminal({
                cursorBlink: true,
                fontFamily: 'monospace',
                theme: {
                    background: 'black',
                    foreground: 'white'
                },
                scrollback: 1000,
                disableStdin: false,
                rendererType: 'canvas'
            });
            const fitAddon = new FitAddon.FitAddon();
            const webLinksAddon = new WebLinksAddon.WebLinksAddon();
            term.loadAddon(fitAddon);
            term.loadAddon(webLinksAddon);
            const termContainer = document.createElement('div');
            termContainer.style.flex = '1';
            termContainer.className = 'xterm-container';
            terminalContainer.appendChild(termContainer);
            term.open(termContainer);
            fitAddon.fit();

            const sessionId = Date.now();
            logs[sessionId] = '';
            const socket = new WebSocket(`ws${window.location.protocol === 'https:' ? 's' : ''}://${window.location.host}`);
            socket.onopen = () => console.log('WebSocket connection established');
            socket.onmessage = (event) => {
                const { sessionId: msgSessionId, data } = JSON.parse(event.data);
                if (sessionId === msgSessionId) {
                    term.write(data);
                    logs[sessionId] += data; // Log output
                }
            };
            socket.onerror = (error) => console.error('WebSocket error:', error);

            term.onData((data) => {
                socket.send(JSON.stringify({ sessionId, data }));
            });
            window.addEventListener('resize', () => fitAddon.fit());

            return { term, fitAddon, socket, sessionId };
        }

        function switchTerminal(index) {
            if (terminals[currentTerminalIndex]) {
                terminals[currentTerminalIndex].term.destroy();
                terminals[currentTerminalIndex].socket.close();
                const containers = document.querySelectorAll('.xterm-container');
                if (containers[currentTerminalIndex]) {
                    containers[currentTerminalIndex].remove();
                }
            }
            currentTerminalIndex = index;
            if (!terminals[currentTerminalIndex]) {
                terminals[currentTerminalIndex] = createTerminal();
            }
        }

        document.getElementById('new-session-btn').addEventListener('click', () => {
            switchTerminal(terminals.length);
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            if (terminals[currentTerminalIndex]) {
                terminals[currentTerminalIndex].term.clear();
            }
        });

        document.getElementById('save-btn').addEventListener('click', () => {
            alert('Save functionality is not implemented yet.');
        });

        document.getElementById('exit-btn').addEventListener('click', () => {
            if (terminals[currentTerminalIndex]) {
                terminals[currentTerminalIndex].socket.send(JSON.stringify({ sessionId: terminals[currentTerminalIndex].sessionId, data: '\x18' })); // Send Ctrl+X
            }
        });

        document.getElementById('copy-btn').addEventListener('click', () => {
            if (terminals[currentTerminalIndex]) {
                const selection = terminals[currentTerminalIndex].term.getSelection();
                if (selection) {
                    navigator.clipboard.writeText(selection).then(() => {
                        console.log('Text copied to clipboard');
                    }).catch((err) => {
                        console.error('Failed to copy text:', err);
                    });
                }
            }
        });

        document.getElementById('download-btn').addEventListener('click', () => {
            if (terminals[currentTerminalIndex]) {
                const sessionId = terminals[currentTerminalIndex].sessionId;
                const blob = new Blob([logs[sessionId]], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `session_${sessionId}.log`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });

        document.getElementById('command-btn').addEventListener('click', () => {
            if (terminals[currentTerminalIndex]) {
                const command = prompt('Enter command to run:');
                if (command) {
                    terminals[currentTerminalIndex].socket.send(command + '\n');
                }
            }
        });

        // Initialize first terminal session
        switchTerminal(0);
    </script>
</body>
</html>
